<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FeiScale - 身体数据监控</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #3b82f6; --accent: #10b981; --bg: #f8fafc; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 100%; max-width: 600px; box-sizing: border-box; }
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; color: #1e293b; letter-spacing: -0.5px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #f1f5f9; padding: 10px; border-radius: 12px; text-align: center; }
        .stat-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
        .stat-value { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .input-area { margin-top: 25px; display: flex; gap: 8px; flex-wrap: wrap; border-top: 1px solid #e2e8f0; padding-top: 20px; }
        input { flex: 1; min-width: 120px; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        .footer-tips { font-size: 11px; color: #94a3b8; text-align: center; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>FeiScale</h1>
        <p style="font-size: 12px; color: #64748b; margin-top: 5px;">身高: 1.81m</p>
    </header>

    <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">最新体重</div><div id="curW" class="stat-value">--</div></div>
        <div class="stat-card"><div class="stat-label">最新 BMI</div><div id="curBMI" class="stat-value" style="color:var(--accent)">--</div></div>
        <div class="stat-card"><div class="stat-label">总减重</div><div id="totalLoss" class="stat-value" style="color:#ef4444">--</div></div>
    </div>

    <canvas id="mainChart"></canvas>

    <div class="input-area">
        <input type="date" id="newDate">
        <input type="number" id="newWeight" step="0.01" placeholder="体重 (kg)">
        <button onclick="addRecord()">记录/更新</button>
    </div>
    
    <div class="footer-tips">同一天的记录会直接覆盖更新</div>
</div>

<script>
    const HEIGHT = 1.81;
    const historyData = [
        { date: '2025-12-09', weight: 80.90 }, { date: '2026-01-22', weight: 77.10 },
        { date: '2026-01-24', weight: 76.60 }, { date: '2026-01-25', weight: 76.30 },
        { date: '2026-01-26', weight: 76.30 }, { date: '2026-01-27', weight: 75.70 },
        { date: '2026-01-28', weight: 75.70 }, { date: '2026-01-29', weight: 75.10 },
        { date: '2026-01-30', weight: 75.10 }, { date: '2026-01-31', weight: 74.70 },
        { date: '2026-02-01', weight: 74.40 }, { date: '2026-02-02', weight: 74.30 },
        { date: '2026-02-03', weight: 73.50 }, { date: '2026-02-04', weight: 73.80 },
        { date: '2026-02-05', weight: 73.80 }, { date: '2026-02-08', weight: 73.00 },
        { date: '2026-02-09', weight: 73.20 }, { date: '2026-02-10', weight: 72.30 },
        { date: '2026-02-11', weight: 72.80 }
    ];

    let myRecords = JSON.parse(localStorage.getItem('fei_weight_logs')) || historyData;
    let chart;

    function calcBMI(weight) { return (weight / (HEIGHT * HEIGHT)).toFixed(2); }

    function init() {
        const latest = myRecords[myRecords.length - 1];
        const initial = myRecords[0];
        document.getElementById('curW').innerText = latest.weight.toFixed(1) + 'kg';
        document.getElementById('curBMI').innerText = calcBMI(latest.weight);
        document.getElementById('totalLoss').innerText = (initial.weight - latest.weight).toFixed(1) + 'kg';
        document.getElementById('newDate').valueAsDate = new Date();
        renderChart();
    }

    function renderChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: myRecords.map(r => r.date.slice(5)),
                datasets: [
                    {
                        label: '体重 (kg)',
                        data: myRecords.map(r => r.weight),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        yAxisID: 'y',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'BMI',
                        data: myRecords.map(r => calcBMI(r.weight)),
                        borderColor: '#10b981',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        yAxisID: 'y1',
                        tension: 0.3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false } },
                scales: {
                    y: { type: 'linear', position: 'left', title: { display: true, text: '体重 (kg)', font: { size: 10 } } },
                    y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'BMI', font: { size: 10 } } }
                }
            }
        });
    }

    // 核心逻辑修改：查找现有记录并覆盖
    function addRecord() {
        const date = document.getElementById('newDate').value;
        const weight = parseFloat(document.getElementById('newWeight').value);
        if(!date || !weight) return alert('请正确输入');

        // 查找是否已经存在该日期的索引
        const existingIndex = myRecords.findIndex(r => r.date === date);

        if (existingIndex !== -1) {
            // 如果存在，更新体重
            myRecords[existingIndex].weight = weight;
        } else {
            // 如果不存在，添加新记录
            myRecords.push({ date, weight });
        }

        // 重新按日期排序（以防用户补录之前的日期）
        myRecords.sort((a,b) => new Date(a.date) - new Date(b.date));
        
        localStorage.setItem('fei_weight_logs', JSON.stringify(myRecords));
        document.getElementById('newWeight').value = '';
        init();
    }

    init();
</script>
</body>
</html>